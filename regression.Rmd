---
title: "Regression"
author: "Sahana Rayan"
date: "June 22, 2020"
output: html_document
---

#Loading the dataset
```{r message = FALSE, error=FALSE, warning=FALSE}
library(tidyverse)
tennis_data <- read_csv("http://www.stat.cmu.edu/cmsac/sure/materials/data/regression_projects/tennis_2013_2017_GS.csv")
```

#Cleaning the dataset
When looking at the composition of certain variables, lack of variation in these variables was identified.
```{r}
table("Retirement Binary Variable" = tennis_data$Retirement)
table("Winning player's sets won" = tennis_data$w_setswon)
```
 
Some variables were also redundant, as shown below, that required to be removed

```{r}
table("Slam" = tennis_data$slam,
      "Tournament" = tennis_data$tournament)
```


This information helped in creating this cleaned dataframe
```{r}
tennis_data_cleaned <- tennis_data %>% 
  select(-c("w_n_netpt_w", "w_n_netpt", "slam", "player1", "player2", "a1", "a2", "X1", "match_id.y")) %>% 
  rename(Net_points = l_n_netpt,
         Net_points_won = l_n_netpt_w) %>% 
  mutate(w_bp_success = w_n_bp_w/w_n_bp,
         l_bp_success = l_n_bp_w/l_n_bp,
         w_sv_success = w_n_sv_w/w_n_sv,
         l_sv_success = l_n_sv_w/l_n_sv,
         upset_bool = ifelse(winner_rank >loser_rank, TRUE, FALSE)) %>% 
  filter(Retirement == FALSE) %>% 
  filter(w_setswon %in% c(2,3))
```

The __select__ line removed all the redundant variables. The __rename__ function was used to rename certain variables to fit the context of the dataframe. The __mutate__ function was used to add some variables that we though couldbe worth looking at for EDA. These variables are serve success, break point success and a boolean variable that determines whether that particular match was an upset match. The __filter__ was used to filter out data that lacked variation.


#EDA for continuous variables
The correlation matrix was used to look at the linear relationships between certain continuous variables that we were interested in

```{r}
library(ggcorrplot)
tennis_model_data <- tennis_data_cleaned %>%
  dplyr::select(w_n_winners, #winning player's number of winners
                w_bp_success,#Winning player's breakpoint success
                w_sv_success,#Winning player's serve success
                w_pointswon, #Winning player's points won
                w_n_ue,      #Winning player's number of unforced errors
                l_n_ue,      #Losing player's number of unforced errors
                w_n_sv_w,    #Winning player's number of serve wins
                w_gameswon)  #Winning player's number of games won
tennis_cor_matrix <- cor(tennis_model_data)
ggcorrplot(tennis_cor_matrix)

round_cor_matrix <- 
  round(cor(tennis_model_data), 2)
ggcorrplot(round_cor_matrix, 
           hc.order = TRUE,
           type = "lower",
           lab = TRUE)

```

The losing player's number of unforced errors, winning player's number of winners, winning player's games won, winning player's number of serve wins, and winning player's number of unforced errors had a strong correlation with winning player's total points won

*w_pointswon* appeared to be an interesting variable and a potential response variable for the linear regression model and so the distrubution of this variable looked like this
```{r}
tennis_data_cleaned %>% 
  ggplot() +
  geom_histogram(aes(x = w_pointswon)) +
  xlab("Winning player's points won") +
  theme_bw()
```


The distribution appears to have some outliers and once these outliers are removed, the distribution looks like this:
```{r}
tennis_data_cleaned %>% 
  filter((w_pointswon > 50) & (w_pointswon < 200)) %>%
  ggplot() +
  geom_histogram(aes(x = w_pointswon)) +
  xlab("Winning player's points won") +
  theme_bw()
tennis_data_linear <- tennis_data_cleaned %>% 
  filter((w_pointswon > 50) & (w_pointswon < 200))
```

The **tennis_data_linear** is a dataframe containing data with the outliers in the *w_pointswon* distribution removed. This dataframe will be used in the rest of the project. 

The scatterplots for the aforementioned variables against *w_pointswon* were plotted


```{r messsage = FALSE}
stat.lab <- c("Losing player's number of unforced errors", "Winning player's number of serve wins", 
              "Winning player's number of unforced errors", "Winning player's number of winners",
              "Winning player's games won")
names(stat.lab) <- c("l_n_ue", "w_n_sv_w", "w_n_ue", "w_n_winners", "w_gameswon")
tennis_data_linear%>% 
  pivot_longer(c("w_n_ue", "w_n_winners", "l_n_ue", "w_n_sv_w", "w_gameswon"),
               names_to = "Stat", 
               values_to = "Values") %>% 
  ggplot(aes(x = Values, y = w_pointswon)) +
  geom_point(alpha = .2) +
  facet_wrap(~Stat, scales = "free_x", labeller = labeller(Stat = stat.lab)) +
  geom_smooth(method = "lm") +
  ylab("Winning player's total points won") +
  theme_bw() +
  labs(
    title = "Different variables vs Winning player's points won scatterplot"
  )
```

___Note: the winning player's games won will be made into a bar chart because of its discrete nature__

These promising scatter plots led us to select *w_pointswon* as a response variable.


But, in order to look at linear relationships among explanatory variables, pairs plots were used. This is important in detecting any redundancies within the model as in an ideal situation, all explanatory variables are independent of one and other.

```{r message = FALSE}
library(GGally)
ggpairs(tennis_data_linear,
        columns =
          c("w_n_ue", "l_n_ue", "w_n_winners", "w_n_sv_w", "w_gameswon"),
        mapping = aes(alpha = 0.2)) +
  theme_bw()

```

#Hierarchial Clustering of variables

Hierarchial Clustering of variables is also a great way to group variables that are similar or variables that shows dependencies on each other. Other continuous variables (variables in the correlation matrix) were also included in this clustering model.

```{r}
tennis_ex_vars <- dplyr::select(tennis_model_data, -w_pointswon)
exp_cor_matrix <- cor(tennis_ex_vars)
cor_dist_matrix <- 1 - abs(exp_cor_matrix)
cor_dist_matrix <- as.dist(cor_dist_matrix)

library(ggdendro)
tennis_exp_hc <- hclust(cor_dist_matrix,
                     "complete")
ggdendrogram(tennis_exp_hc,
             rotate = TRUE,
             size = 2)
             
#library(dendextend)
#cor_dist_matrix %>%
  #hclust() %>%
  #as.dendrogram() %>%
  #set("branches_k_col", 
     # k = 2) %>% 
  #set("labels_cex", .9) %>%
  #ggplot(horiz = TRUE)

```

Both the dendrogram and the pairs plot indicate that *w_n_sv_w*,  *w_n_winners*, and *w_gameswon* have a high correlation with each other and when they are included in the linear regression model, these variables might create some redundancy.


#EDA for Discrete Variables

_round_, _tour_, _Tournament_, _Year_, *w_setswon*, are a couple of categorical variables that could potentially affect *w_pointswon*

Box plots along with violin plots were useful in determining this relationship
```{r}
tennis_data_linear %>% 
  ggplot(aes(x = as.factor(w_setswon), y = w_pointswon)) +
  geom_violin() +
  geom_boxplot(width = .2) + 
  xlab("Winning player's number of sets won") +
  ylab("Winning player's Total points won") +
  labs(title = "Violin and Box plots for sets won and points won") +
  theme_bw()
```


As expected, there seems to be a relationship between total points won and number of sets won.

```{r}
tennis_data_linear %>%
  ggplot(aes(x = Tour, y = w_pointswon)) +
  geom_violin() +
  geom_boxplot(width = .2) + 
  xlab("Tour") +
  ylab("Winning player's Total points won") +
  labs(title = "Violin and Box plots for Women's/Men's league and points won") +
  scale_x_discrete(label = c("Association for Tennis Players (Men's)", "Womens Tennis Association")) +
  theme_bw()
```

There is distinct difference in distribution of *w_pointswon* in the Men's and Women's league of tennis.

These clear differences cannot be observed with _tournament_, _round_, and _Year_ as shown below with _tournament_ variable

```{r}
tennis_data_linear %>%
  ggplot(aes(x = tournament, y = w_pointswon)) +
  geom_violin() +
  geom_boxplot(width = .2) + 
  xlab("Tournament") +
  ylab("Winning player's Total points won") +
  labs(title = "Violin and Box plots for different tournaments and points won") +
  theme_bw()
```

#Linear Modeling

Explanatory Variables of interest include *w_n_winners*, *w_n_ue*, *Tour*, *w_setswon*, *l_n_ue*, *w_gameswon*
Response Variiable in question is *w_pointswon*

```{r}
tennis_data_cleaned < 
init_w_pointswon <- lm(w_pointswon ~ w_n_winners + w_n_ue + Tour + as.factor(w_setswon) + l_n_ue + w_gameswon, tennis_data_linear)
summary(init_w_pointswon)
library(ggfortify)
autoplot(init_w_pointswon, 
         which = 1:6,
         alpha = .2,
         ncols = 3) +
  theme_bw()
```

__Note:The analysis of these plots will be done soon__

The data was split into train and test.
```{r}
#Train-Test split
set.seed(4345)
n_players <- nrow(tennis_data_linear)
train_i <- sample(n_players, n_players * 0.7, replace = FALSE)
test_i <- (1:n_players)[-train_i]
tennis_train <- tennis_data_linear[train_i,]
tennis_test <- tennis_data_linear[test_i,]
```

Two models (one with *w_setswons* and one without) were trained and tested
```{r}
candidate_model_2 <- lm(w_pointswon ~ w_n_winners + w_n_ue  + l_n_ue + w_gameswon + Tour, tennis_train)
model_2_preds <- predict(candidate_model_2, newdata = tennis_test)
model_2_mse <- mean((model_2_preds - tennis_test$w_pointswon)^2)
model_2_mse

candidate_model_3 <- lm(w_pointswon ~ w_n_winners + w_n_ue  + l_n_ue + w_gameswon + as.factor(w_setswon)+ Tour, tennis_train)
model_3_preds <- predict(candidate_model_3, newdata = tennis_test)
model_3_mse <- mean((model_3_preds - tennis_test$w_pointswon)^2)
model_3_mse
```

__Note: K-fold cross validation is yet to be performed on these models and more linear modelling will be done soon.__
